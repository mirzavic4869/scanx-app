import { Button } from '@/components/button'
import { Input } from '@/components/input'
import { CardScan } from '@/components/card'
import Swal from 'sweetalert2'
import { deleteCookie, getCookie } from 'cookies-next'
import { useState } from 'react'
import axios from 'axios'
import { useRouter } from 'next/router'
import { baseURL } from '@/components/lib'

export default function ExploitationTools() {
  const value = [
    {
      id: '1',
      title: 'Command Line',
      url: '/exploitation-tools',
    },
    {
      id: '2',
      title: 'Pishing',
      url: 'http://phis.scanx.my.id/',
    },
    {
      id: '3',
      title: 'Brute Force',
      url: '/exploitation-tools/brute-force',
    },
  ]

  const session = getCookie('session')
  const router = useRouter()
  const [input, setInput] = useState('')
  const [scanResult, setScanResult] = useState()

  const handleSubmit = (e) => {
    e.preventDefault()
    toScan(input)
  }

  async function toScan(input) {
    try {
      const payload = {
        command: input,
      }
      const result = await axios({
        method: 'POSt',
        url: `${baseURL}/popupcli`,
        data: payload,
        headers: {
          Authorization: `Bearer ${session}`,
          'Content-Type': 'application/json',
        },
      })
      setScanResult(result.data)
      setInput('')
    } catch (error) {
      if (error.response?.status === 422) {
        await Swal.fire('Sorry', 'masa berlaku token anda telah habis', 'error')
        deleteCookie('session')
        router.push('/login')
      } else {
        await Swal.fire('Sorry', error.response.data.error_message, 'error')
      }
    }
  }

  return (
    <div className="flex flex-col">
      <h1 className="mb-5 text-lg font-semibold md:text-2xl">
        Exploitation Tools
      </h1>
      <div className="mb-4 flex w-full items-center gap-3 lg:gap-5">
        <Input
          onChange={(e) => setInput(e.target.value)}
          name="url"
          placeholder="x1/x2/x3/x4[space]yourdomain.com[space]html/csv/json"
        />
        <Button onClick={handleSubmit}>Scan</Button>
      </div>
      <div className="grid gap-4 md:grid-cols-4 lg:grid-cols-6">
        <CardScan title="Scanning Tools" value={value} />
        <div className="flex flex-col rounded bg-white p-4 shadow-sm hover:shadow-md md:col-span-5">
          <h1 className="mb-3 font-semibold">Scan Result</h1>
          {scanResult &&
            Object.entries(scanResult).map(([key, value], index) => (
              <div key={index}>
                <p>
                  {key}: {value === false ? String(value) : value}
                </p>
              </div>
            ))}
        </div>
      </div>
    </div>
  )
}
